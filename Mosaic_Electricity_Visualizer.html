<html>
    <head>
        <title>Mosaic's Electricity Load Model</title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <style>
            /* Your existing styles unchanged */
            html, body { margin: 0; padding: 0; height: 100vh; overflow: hidden; font-family: 'Arial', sans-serif; }
            .header { background: linear-gradient(135deg, #2c3e50, #3498db); padding: 10px 20px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: fixed; width: 100%; top: 0; z-index: 1000; height: 50px; box-sizing: border-box; display: flex; align-items: center; }
            .header-title { margin: 0; font-size: 20px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
            #map { position: absolute; top: 50px; left: 0; width: 100%; height: calc(100vh - 50px); z-index: 1; }
            .leaflet-top { margin-top: 10px; }
            #opacity-slider { width: 200px; margin-top: 10px; }
            .logo-container { position: absolute; bottom: 10px; left: 10px; z-index: 1001; pointer-events: none; }
            .logo-container img { width: 100px; height: auto; opacity: 0.8; }
            .info.legend { 
                background: white; 
                padding: 10px 15px; 
                border: 1px solid #ccc; 
                border-radius: 5px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.2); 
                font-size: 14px;
                line-height: 1.5;
                width: 220px;
            }
            /* Legend Styles */
            .legend-container {
                position: absolute;
                bottom: 20px;
                right: 12px;
                background: rgba(255, 255, 255, 0.9);
                padding: 10px;
                border-radius: 3px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                font-size: 7px;
                width: 220px;
                z-index: 1000;
            }

            .legend-title {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 5px;
            }

            .legend-subtitle {
                font-size: 10px;
                margin-bottom: 10px;
            }

            .legend-gradient {
                width: 20px;
                height: 100px;
                background: linear-gradient(to top, #1e1e4c, #265b7c, #3ea646, #fffb00);
                float: left;
                margin-right: 10px;
                border-radius: 3px;
            }

            .legend-labels {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                height: 100px;
                font-size: 9px;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1 class="header-title">Mapping Energy Access & Needs in Indonesia</h1>
        </div>
        <div id="map">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/geo2004/leaflet/refs/heads/master/logo_mosaic.png" alt="Mosaic Risk Analytics PTE Ltd" />
            </div>
        </div>
<!-- Legend -->
<div class="legend-container">
    <div class="legend-title">Legend</div>
    
    <!-- Night Light Intensity Legend -->
    <div class="legend-subtitle">Night Light Intensity</div>
    <div style="display: flex; align-items: center;">
        <div class="legend-gradient" style="background: linear-gradient(to top, #1e1e4c, #265b7c, #3ea646, #fffb00);"></div>
        <div class="legend-labels">
            <div>Bright Artificial Lights (Cities, Industrial Zones)</div>
            <div>Dim Artificial Lights (Small Settlements, Roads)</div>
            <div>Natural Background Lights (Moon, Airglow)</div>
            <div>No Detectable Lights</div>
        </div>
    </div>
    
    <hr>
    
    <!-- Population Density Legend -->
    <div class="legend-subtitle">Population Headcount per Village</div>
    <div style="display: flex; flex-direction: column;">
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #FFFFD9; margin-right: 10px;"></div><span>< 2000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #EFF9B5; margin-right: 10px;"></div><span>2000 - 4000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #CFECB3; margin-right: 10px;"></div><span>4000 - 6000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #97D6B9; margin-right: 10px;"></div><span>6000 - 8000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #5DC0C0; margin-right: 10px;"></div><span>8000 - 11000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #31A6C2; margin-right: 10px;"></div><span>11000 - 15000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #1F80B8; margin-right: 10px;"></div><span>15000 - 22000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #2355A4; margin-right: 10px;"></div><span>22000 - 33000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #22318D; margin-right: 10px;"></div><span>33000 - 51000</span></div>
        <div style="display: flex; align-items: center;"><div style="width: 20px; height: 15px; background: #081D58; margin-right: 10px;"></div><span>> 51000</span></div>
    </div>
</div>
        <!-- Load Leaflet -->
        <script src="https://unpkg.com/leaflet@1.9.0/dist/leaflet.js"></script>
        <!-- Load PMTiles -->
        <script src="https://unpkg.com/pmtiles@2.7.2/dist/index.js"></script>
       
        <script>
            // Initialize map
            const map = L.map('map').setView([-2.923869442014587, 117.53529870695202], 5);

            // Basemaps
            const googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '© Google'
            });

            const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 20,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // Layer groups
            const csvLayer = L.layerGroup();
            let populationLayer, viirsLayer;
            const overlays = { "PLTD Locations": csvLayer };
  
            // Load CSV (unchanged)
            async function loadCSV() {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/geo2004/leaflet/refs/heads/master/DATA_54_FIXED.csv');
                    const csvText = await response.text();
                    const rows = csvText.split('\n').map(row => row.split(','));
                    const headers = rows[0];
                    rows.slice(1).forEach(row => {
                        if (row.length < headers.length) return;
                        const lat = parseFloat(row[5]);
                        const lon = parseFloat(row[6]);
                        if (isNaN(lat) || isNaN(lon)) return;
                        const marker = L.marker([lat, lon]);
                        const maxLoadKW = parseFloat(row[4]).toFixed(2);
                        marker.bindPopup(`<b>${row[2]}</b><br>Region: ${row[1]}<br>Maximum Load (kW): ${maxLoadKW}<br>Population Density: ${row[8]}<br>Headcount (5km): ${row[9]}`);
                        marker.addTo(csvLayer);
                    });
                    csvLayer.addTo(map);
                } catch (error) {
                    console.error('Error loading CSV:', error);
                }
            }

            // Load VIIRS (unchanged)
            const viirsPmtiles = new pmtiles.PMTiles("https://raw.githubusercontent.com/geo2004/leaflet/refs/heads/master/VIIRS_SE_Asia_2023.pmtiles");
            viirsPmtiles.getHeader().then(() => {
                viirsLayer = pmtiles.leafletRasterLayer(viirsPmtiles, { maxZoom: 20, minZoom:0, maxNativeZoom: 11, opacity: 0.5 });
                overlays["VIIRS Night Lights"] = viirsLayer;
                viirsLayer.addTo(map);
            });

            // Load Population (unchanged)
            const populationPmtiles = new pmtiles.PMTiles("https://raw.githubusercontent.com/geo2004/leaflet/refs/heads/master/Population_Raster.pmtiles");
            populationPmtiles.getHeader().then(() => {
                populationLayer = pmtiles.leafletRasterLayer(populationPmtiles, { maxZoom: 20,minZoom:0, maxNativeZoom: 11, opacity: 0.5 });
                overlays["Population Headcount"] = populationLayer;
                populationLayer.addTo(map);
            });

            // Layer control and opacity slider
            Promise.all([viirsPmtiles.getHeader(), populationPmtiles.getHeader(), loadCSV()]).then(() => {
                const layerControl = L.control.layers({ "Satellite": googleSatellite, "Street Map": cartoPositron }, overlays, { collapsed: false }).addTo(map);

                const slider = document.createElement('input');
                slider.id = 'opacity-slider';
                slider.type = 'range';
                slider.min = 0;
                slider.max = 1;
                slider.step = 0.1;
                slider.value = 0.5;
                slider.addEventListener('input', (e) => {
                    const opacity = parseFloat(e.target.value);
                    if (viirsLayer) viirsLayer.setOpacity(opacity);
                    if (populationLayer) populationLayer.setOpacity(opacity);
                });

                const container = document.querySelector('.leaflet-control-layers');
                const label = document.createElement('div');
                label.textContent = 'Layers Opacity:';
                container.appendChild(label);
                container.appendChild(slider);
                
            });
        </script>
    </body>
</html>