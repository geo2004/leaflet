<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Leaflet – Male/Female Schools Layers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; }
  #map { width: 100%; height: 100%; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- Map Setup ----------------
const map = L.map('map', {
  fadeAnimation: false,
  zoomAnimation: false,
  markerZoomAnimation: false,
  preferCanvas: true
}).setView([23.8859, 45.0792], 6);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

map.on('movestart', () => map.closePopup());

// ---------------- Helper Functions ----------------
function createPopupContent(props) {
  let html = "<table style='font-size:13px; margin:5px 0'>";
  for (let key in props) {
    html += `<tr><td><b>${key}</b></td><td>&nbsp;${props[key] || ''}</td></tr>`;
  }
  return html + "</table>";
}

function schoolColor(cat) {
  return { "1": "#e74c3c", "2": "#3498db", "3": "#2ecc71", "4": "#f1c40f" }[cat] || "#7f8c8d";
}

const isFemale = p => p.d_school_t === "females";

// ---------------- Layer Definitions ----------------
// Cluster Zones
const styleCluster = f => ({ color: schoolColor(f.properties.cluster_category), weight: 3, fillOpacity: 0 });
const onEach = (f, l) => l.bindPopup(createPopupContent(f.properties));

const maleClusterLayer = L.geoJSON(null, { style: styleCluster, onEachFeature: onEach });
const femaleClusterLayer = L.geoJSON(null, { style: styleCluster, onEachFeature: onEach });

// Schools: Male = Circle, Female = Circle with black outline
const maleSchoolsLayer = L.geoJSON(null, {
  pointToLayer: (feature, latlng) => {
    const color = schoolColor(feature.properties.cluster_category);
    return L.circleMarker(latlng, { radius:6, color: "white", weight:1.5, fillColor: color, fillOpacity:0.9 });
  },
  onEachFeature: onEach
});

const femaleSchoolsLayer = L.geoJSON(null, {
  pointToLayer: (feature, latlng) => {
    const color = schoolColor(feature.properties.cluster_category);
    return L.circleMarker(latlng, { radius:6, color: "black", weight:1.5, fillColor: color, fillOpacity:0.9 });
  },
  onEachFeature: onEach
});

// Radius Layers (optional, separate male/female)
const maleRadiusLayer = L.geoJSON(null, { style:{color:"#9b59b6", weight:3, fillOpacity:0}, onEachFeature:onEach });
const femaleRadiusLayer = L.geoJSON(null, { style:{color:"#59b6a0", weight:3, fillOpacity:0}, onEachFeature:onEach });

// ---------------- Data Loader (Progressive + Split by Gender) ----------------
function loadAndSplit(url, layerMale, layerFemale, clusterMale=null, clusterFemale=null, radiusMale=null, radiusFemale=null, fitAfter=false) {
  fetch(url).then(r=>r.json()).then(data=>{
    const features = data.features || [];
    const maleFeatures = features.filter(f => !isFemale(f.properties));
    const femaleFeatures = features.filter(f => isFemale(f.properties));
    
    // Progressive loading
    const chunk = 3000;
    function processList(list, layer) {
      let i=0;
      function addChunk() {
        const end = Math.min(i + chunk, list.length);
        if(i < end){
          layer.addData({ type:"FeatureCollection", features: list.slice(i,end) });
        }
        i=end;
        if(i < list.length) requestAnimationFrame(addChunk);
      }
      requestAnimationFrame(addChunk);
    }

    processList(maleFeatures, layerMale);
    processList(femaleFeatures, layerFemale);

    if(clusterMale && clusterFemale){
      processList(maleFeatures, clusterMale);
      processList(femaleFeatures, clusterFemale);
    }
    if(radiusMale && radiusFemale){
      processList(maleFeatures, radiusMale);
      processList(femaleFeatures, radiusFemale);
    }

    if(fitAfter){
      setTimeout(()=>{
        const group = L.featureGroup([layerMale, layerFemale]);
        if(group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.1));
      }, 800);
    }
  }).catch(err=>console.error("Error loading "+url, err));
}

// ---------------- Load Data ----------------
loadAndSplit("Cluster_Zones.geojson", maleClusterLayer, femaleClusterLayer, true);
loadAndSplit("Schools.geojson", maleSchoolsLayer, femaleSchoolsLayer);
loadAndSplit("Radius_70km.geojson", maleRadiusLayer, femaleRadiusLayer);

// ---------------- Layer Control ----------------
const overlayMaps = {
  "Male Schools Cluster Zones": maleClusterLayer,
  "Female Schools Cluster Zones": femaleClusterLayer,
  "Male Schools": maleSchoolsLayer,
  "Female Schools": femaleSchoolsLayer,
  "Male Schools Radius (70km)": maleRadiusLayer,
  "Female Schools Radius (70km)": femaleRadiusLayer
};

L.control.layers(null, overlayMaps, { collapsed:false }).addTo(map);

// ---------------- Add All Layers ----------------
maleClusterLayer.addTo(map);
femaleClusterLayer.addTo(map);
maleSchoolsLayer.addTo(map);
femaleSchoolsLayer.addTo(map);
maleRadiusLayer.addTo(map);
femaleRadiusLayer.addTo(map);

</script>
</body>
</html>
